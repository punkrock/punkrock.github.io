<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>punkrock.github.io</title>
  <meta name="description" content="Ressources for mining, forging and validating. Vote for punkrock!">
  <meta name="author" content="punkrock">

<!-- <link rel="stylesheet" href="css/styles.css?v=1.0"> -->

<style type="text/css">
	body {font-family: Arial, Helvetica, sans-serif;}
  .highlighted-div { background-color: #ecffcb; width: auto; padding: 20px; display: inline-block }
	.inner-pre {font-size: 18px; font-family: Arial, Helvetica, sans-serif; font-weight: bold;}
  .nohigh {
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
  }
  #update {
  background-color: #f0f0f0 ;
  padding: 10px ;
  border: 1px solid green ;
} 
  #box {
  background-color: #f0f0f0 ;
  padding: 10px ;
  border: 1px solid green ;
} 
</style>

</head>

<body>

  <pre>    ______  _   _  _   _  _   ________  _____  _____  _   __
    | ___ \| | | || \ | || | / /| ___ \|  _  |/  __ \| | / /
    | |_/ /| | | ||  \| || |/ / | |_/ /| | | || /  \/| |/ / 
    |  __/ | | | || . ` ||    \ |    / | | | || |    |    \ 
    | |    | |_| || |\  || |\  \| |\ \ \ \_/ /| \__/\| |\  \
    \_|     \___/ \_| \_/\_| \_/\_| \_| \___/  \____/\_| \_/
</pre>
<pre>---------------------------------------------------------------------------
<span class="inner-pre"><a href="https://punkrock.github.io">Home</a> | <a href="https://punkrock.github.io/lisk.html">Lisk</a></span>
---------------------------------------------------------------------------
</pre>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h1><strong>Lisk API & Service for Lisk Core v3 on Uubuntu 20.04<br /><br /></strong></h1>

<h1>Summary</h1>
0. <a href="#step0">Hardware requirements</a><br>
1. <a href="#step1">Add A-Records for api and service</a><br>
2. <a href="#step2">Create user and install some stuff</a><br>
3. <a href="#step3">Secure SSH</a><br>
4. <a href="#step4">Config Firewall</a><br>
5. <a href="#step5">Install Lisk Core</a><br>
6. <a href="#step6">Install pm2</a><br>
7. <a href="#step7">Install MySQL Server</a><br>
8. <a href="#step8">Install Redis</a><br>
9. <a href="#step9">Install Lisk Service</a><br>
10. <a href="#step10">Config Nginx and get TLS certificates</a><br>
11. <a href="#step11">Install market</a><br>
12. <a href="#step12">"Start everything"-script</a><br>
13. <a href="#step13">Reboot Cronjob</a><br>
14. <a href="#step14">Update Lisk Service</a><br>
15. <a href="#step15">Credits</a><br>
<br><br><br>

<h3 id="step0">0. Requirements</h3>
I recommend a server with 2 or 4 CPU's and a minimum of 8 GB RAM for a reliable Service/API-node!
<br><br>

<h3 id="step1">1. Add A-Records for api and service</h3>
<em>Login to your domain hoster and set two A RECORDS for api and service.<br><br>
This example will result in the domains:<br>
- https://lisk-mainnet-api.YourDomain.tld<br>
- https://lisk-mainnet-service.YourDomain.tld</em><br><br>

<img src="./a-records.jpg">

<br><br><br><br>
<h3 id="step2">2. Create user and install some stuff</h3>

<code><p><span class="nohigh">~# </span> adduser lisk</code>
<code><p><span class="nohigh">~# </span> gpasswd -a lisk sudo</code>
<code><p><span class="nohigh">~# </span> visudo</code><br><br>

<em>Add this line to the end of the file:</em>
<div id="box"><pre>lisk ALL=(ALL) NOPASSWD: ALL</pre></div>

<code><p><span class="nohigh">~# </span> su - lisk</code>

<code><p><span class="nohigh">~$ </span> sudo apt-get -y update && sudo apt-get -y upgrade && sudo apt-get -y dist-upgrade && sudo apt-get -y install wget tar zip unzip ufw htop nano npm git curl bash jq screen && sudo apt-get -y install unattended-upgrades && sudo nano /etc/apt/apt.conf.d/20auto-upgrades</code>
<br><br><em>Add this to the file:</em>
<div id="box">
<pre>
APT::Periodic::Update-Package-Lists "1";
APT::Periodic::Download-Upgradeable-Packages "1";
APT::Periodic::AutocleanInterval "7";
APT::Periodic::Unattended-Upgrade "1";
</pre></div>
<br><em>Save & exit</em><br><br>

<code><p><span class="nohigh">~$ </span> sudo apt-get install -y build-essential git make</code>

<code><p><span class="nohigh">~$ </span> sudo apt install nginx -y</code>

<br><br><br><br>

<h3 id="step3">3. Secure SSH</h3>

<code><p><span class="nohigh">~$ </span> cd && mkdir .ssh && cd .ssh && ssh-keygen -o -a 100 -t ed25519</code>
<br><br><em>Always press ENTER to confirm</em></br></code>

<code><p><span class="nohigh">~$ </span> cat id_ed25519.pub >> authorized_keys</code>

<code><p><span class="nohigh">~$ </span> chmod 600 authorized_keys && cd .. && chmod 700 .ssh</code>
<br><br><em>
Save the private key (id_XXXXXXX) to your hard drive. <br>Then delete the private key (id_XXXXXXX) and the public key (id_XXXXXXX.pub) on your server</em>

<code><p><span class="nohigh">~$ </span> sudo nano /etc/ssh/sshd_config</code>

<div id="box"><pre>Port 24</pre></div>
<br>
<div id="box">
<pre>
# Authentication:
LoginGraceTime 120
PermitRootLogin no
StrictModes yes
AuthorizedKeysFile	%h/.ssh/authorized_keys
PermitEmptyPasswords no
ChallengeResponseAuthentication no
PasswordAuthentication no</pre></div>
<br><em>Save & Exit</em><br><br>

<code><p><span class="nohigh">~$ </span> sudo /etc/init.d/ssh restart</code><br><br>

<em>Now edit your SSH settings with your new port and keys and start a new session.</em>

<br><br><br><br>

<h3 id="step4">4. Config Firewall</h3>

<code><p><span class="nohigh">~$ </span> sudo ufw default deny<br>
<span class="nohigh">~$ </span> sudo ufw allow 'Nginx Full'<br>
<span class="nohigh">~$ </span> sudo ufw allow 24,8000,8001/tcp<br>
<span class="nohigh">~$ </span> sudo ufw enable</code>
<br><br><em>Confirm with "yes"</em>

<br><br><br><br>
<h3 id="step5">5. Install Lisk Core</h3>

<code><p><span class="nohigh">~$ </span> wget -qO- https://raw.githubusercontent.com/nvm-sh/nvm/v0.38.0/install.sh | bash</code>

<br><br><em>Now start a new SSH session!<br><br></em>

<code><p><span class="nohigh">~$ </span>nvm install 12</code>
<code><p><span class="nohigh">~$ </span>npm install --global --production lisk-core</code>
<code><p><span class="nohigh">~$ </span> cd && nano core-start.json</code>

<div id="box">
<pre>
{
  "name": "Lisk Core",
  "script": "lisk-core start --enable-http-api-plugin --api-ws --api-ws-port=8888 --http-api-plugin-port=8000",
  "env": {
    "LISK_NETWORK": "mainnet"
  }
}
</pre>
</div>

<br><br><br>
<h3 id="step6">6. Install pm2</h3>

<code><p><span class="nohigh">~$ </span> sudo npm i -g pm2</code>

<br><br><br><br>
<h3 id="step7">7. Install MySQL Server</h3>

<code><p><span class="nohigh">~$ </span> sudo apt install mysql-server -y</code>
<code><p><span class="nohigh">~$ </span> sudo mysql_secure_installation</code>
<br><br><em>First type "No" (secure password stuff) and choose a simple password like "123" (you will change it to a secure one in the next step). For the other questions type always "Yes".</em>
<br><br>
<em>Now connect to MySQL and change your root password and make sure to use at least 16 characters, lower case, upper case, numbers. Also tested and working are ! " @. <b>Don't use % * = -</b></em>

<code><p><span class="nohigh">~$ </span> sudo mysql -u root -p</code><br><br>

<code>CREATE DATABASE mainnet;</code><br>
<code>ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'Cr4zypa55w0rd!!!"""@qwertz';</code><br>
<code>FLUSH PRIVILEGES;</code><br>
<code>\q</code><br>

<code><p><span class="nohigh">~$ </span> sudo systemctl restart mysql</code>
<code><p><span class="nohigh">~$ </span> sudo systemctl enable mysql</code>


<br><br><br><br>
<h3 id="step8">8. Install Redis</h3>

<code><p><span class="nohigh">~$ </span> sudo apt-get install redis-server -y</code>


<br><br><br><br>
<h3 id="step9">9. Install Lisk Service</h3>

<code><p><span class="nohigh">~$ </span> cd && git clone https://github.com/LiskHQ/lisk-service.git<br>
<span class="nohigh">~$ </span> cd lisk-service && git checkout v0.4.1<br>
<span class="nohigh">~$ </span> git checkout development<br>
<span class="nohigh">~$ </span> make build-local</code><br><br>

<code><p><span class="nohigh">~$ </span> cd && cd lisk-service && nano ecosystem.core3.config.js</code>

<br><br><em>Now empty the file (CTRL + k) completely and add the following <span style="color: #cc0000;"><b>and make sure to change the MySQL password and get a free API-key from exchangeratesapi.io</b></span></em>
<div id="box"><pre>
module.exports = {
    apps: [
        {
            name: 'lisk-service-gateway',
            script: 'app.js',
            cwd: './services/gateway',
            pid_file: './pids/service_gateway.pid',
            out_file: './logs/service_gateway.log',
            error_file: './logs/service_gateway.err',
            log_date_format: 'YYYY-MM-DD HH:mm:ss SSS',
            watch: false,
            kill_timeout: 10000,
            max_memory_restart: '2000M',
//            instances: 1,
            autorestart: true,
            env: {
                PORT: '9901',
                // --- Remember to set the properties below
                SERVICE_BROKER: 'redis://localhost:6379/0',
                ENABLE_HTTP_API: 'http-status,http-version2',
                ENABLE_WS_API: 'blockchain,rpc-v2',
                HTTP_CACHE_CONTROL_DIRECTIVES: 'public, max-age=10',
                ENABLE_HTTP_CACHE_CONTROL: 'true',
                SERVICE_LOG_STDOUT: true,
                SERVICE_LOG_LEVEL: 'info'
            },
        },
        {
            name: 'lisk-service-core',
            script: 'app.js',
            cwd: './services/core',
            pid_file: './pids/service_core.pid',
            out_file: './logs/service_core.log',
            error_file: './logs/service_core.err',
            log_date_format: 'YYYY-MM-DD HH:mm:ss SSS',
            watch: false,
            kill_timeout: 10000,
            max_memory_restart: '2000M',
  //          instances: 1,
            autorestart: true,
            env: {
                // --- Remember to set the properties below
                SERVICE_BROKER: 'redis://localhost:6379/0',
                LISK_CORE_WS: 'ws://localhost:8888',
                SERVICE_CORE_REDIS: 'redis://localhost:6379/1',
                SERVICE_CORE_REDIS_VOLATILE: "redis://localhost:6379/8",
                SERVICE_CORE_MYSQL: 'mysql://root:<span style="color: #cc0000;"><b>PASSWORD</b></span>@localhost:3306/mainnet',
                LISK_STATIC: 'https://static-data.lisk.com',
                GEOIP_JSON: '',
                INDEX_N_BLOCKS: '0',
                ENABLE_TRANSACTION_STATS: 'true',
                TRANSACTION_STATS_HISTORY_LENGTH_DAYS: '366',
                TRANSACTION_STATS_UPDATE_INTERVAL: '3600',
                ENABLE_FEE_ESTIMATOR_QUICK: 'true',
                ENABLE_FEE_ESTIMATOR_FULL: 'false',
                GENESIS_HEIGHT: "16270293",
                GENESIS_BLOCK_URL: 'https://downloads.lisk.io/lisk/main/genesis_block.json.tar.gz',
                SERVICE_LOG_STDOUT: true,
                SERVICE_LOG_LEVEL: 'info',
                SERVICE_LOG_CONSOLE: true
            },
        },
        {
            name: 'lisk-service-market',
            script: 'app.js',
            cwd: './services/market',
            pid_file: './pids/service_market.pid',
            out_file: './logs/service_market.log',
            error_file: './logs/service_market.err',
            log_date_format: 'YYYY-MM-DD HH:mm:ss SSS',
            watch: false,
            kill_timeout: 10000,
            max_memory_restart: '2000M',
//            instances: 1,
            autorestart: true,
            env: {
                // --- Remember to set the properties below
                SERVICE_BROKER: 'redis://localhost:6379/0',
                SERVICE_MARKET_REDIS: 'redis://localhost:6379/2',
                SERVICE_MARKET_FIAT_CURRENCIES: 'EUR,USD,CHF,GBP,RUB',
                SERVICE_MARKET_TARGET_PAIRS: 'LSK_BTC,LSK_EUR,LSK_USD,LSK_CHF,BTC_EUR,BTC_USD,BTC_CHF',
                EXCHANGERATESAPI_IO_API_KEY: '<span style="color: #cc0000;"><b>GET YOUR FREE API KEY FROM: exchangeratesapi.io</b></span>',
                SERVICE_LOG_STDOUT: true,
                SERVICE_LOG_LEVEL: 'info'
            },
        },
    ],
};







</pre></div>


<br><br><br><br>
<h3 id="step10">10. Config Nginx and get TLS certificates</h3>


<code><p><span class="nohigh">~$ </span> sudo nano /etc/nginx/sites-available/default</code>


<br><br><em>Now empty the file (CTRL + k) completely and add the following <span style="color: #cc0000;"><b>and make sure to change the URL's to your domain!</b></span>:</em>

<div id="box"><pre>
server {
    listen      80;
    server_name lisk-mainnet-api.<span style="color: #cc0000;"><b>YourDomain.tld</b></span>;
}

server {
    listen       80;
    server_name lisk-mainnet-service.<span style="color: #cc0000;"><b>YourDomain.tld</b></span>;
}
</pre></div>


<code><p><span class="nohigh">~$ </span> sudo rm -rf /etc/nginx/sites-enabled/default<br>
<span class="nohigh">~$ </span> sudo ln -s /etc/nginx/sites-available/default /etc/nginx/sites-enabled/<br>
<span class="nohigh">~$ </span> sudo systemctl restart nginx<br>
<span class="nohigh">~$ </span> sudo apt install python3-certbot-nginx -y<br>
<span class="nohigh">~$ </span> sudo certbot --nginx -d lisk-mainnet-api.YourDomain.tld -d lisk-mainnet-service.YourDomain.tld</code>
<br><br><em>If asked for redirects, press 2 (redirect)</em>
	
<code><p><span class="nohigh">~$ </span> sudo nano /etc/nginx/sites-enabled/default</code>


<br><br><em>Now empty the file (CTRL + k) completely and add the following <span style="color: #cc0000;"><b>and make sure to change the URL's to your domain!</b></span>:</em>
<div id="box"><pre>
server {
  listen 443 ssl;
  server_name lisk-mainnet-api.<span style="color: #cc0000;"><b>YourDomain.tld</b></span>;
  ssl_certificate /etc/letsencrypt/live/lisk-mainnet-api.<span style="color: #cc0000;"><b>YourDomain.tld</b></span>/fullchain.pem; # managed by Certbot
  ssl_certificate_key /etc/letsencrypt/live/lisk-mainnet-api.<span style="color: #cc0000;"><b>YourDomain.tld</b></span>/privkey.pem; # managed by Certbot
  ssl_verify_client off;
  ssl_protocols TLSv1 TLSv1.1 TLSv1.2;

location /ws {
    proxy_pass http://localhost:8888;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
  }

location / {
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-NginX-Proxy true;
    proxy_pass http://localhost:8000/;
    proxy_ssl_session_reuse off;
    proxy_set_header Host $http_host;
    proxy_cache_bypass $http_upgrade;
    proxy_redirect off;
  }

}

server {
  listen 443 ssl;
  server_name lisk-mainnet-service.<span style="color: #cc0000;"><b>YourDomain.tld</b></span>;
  ssl_certificate /etc/letsencrypt/live/lisk-mainnet-api.<span style="color: #cc0000;"><b>YourDomain.tld</b></span>/fullchain.pem; # managed by Certbot
  ssl_certificate_key /etc/letsencrypt/live/lisk-mainnet-api.<span style="color: #cc0000;"><b>YourDomain.tld</b></span>/privkey.pem; # managed by Certbot
  ssl_verify_client off;
  ssl_protocols TLSv1 TLSv1.1 TLSv1.2;

location / {
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-NginX-Proxy true;
    proxy_pass http://localhost:9901/;
    proxy_ssl_session_reuse off;
    proxy_set_header Host $http_host;
    proxy_cache_bypass $http_upgrade;
    proxy_redirect off;
  }

location /socket.io {
        proxy_http_version 1.1;
        proxy_buffering off;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_pass http://127.0.0.1:9901/socket.io;
}

}

server {
    if ($host = lisk-mainnet-api.<span style="color: #cc0000;"><b>YourDomain.tld</b></span>) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


        listen 80 ;
        listen [::]:80 ;
    server_name lisk-mainnet-api.<span style="color: #cc0000;"><b>YourDomain.tld</b></span>;
    return 404; # managed by Certbot
} 
</pre></div>
<br>
<code><p><span class="nohigh">~$ </span> sudo service nginx restart<br>
<span class="nohigh">~$ </span> sudo certbot renew --dry-run</code>


<br><br><br><br>
<h3 id="step11">11. Install market</h3>

<code><p><span class="nohigh">~$ </span> cd && cd lisk-service/services/market<br>
<span class="nohigh">~$ </span> npm install</code>

<br><br><br><br>
<h3 id="step12">12. "Start everything"-script</h3>

<strong><span style="color: #cc0000;">Important infos:</span></strong><br>
<em>It will now take some time until your node is in sync with the network, that's why we put 120 seconds sleep between the start of Lisk Core and Lisk Service in our starteverything.sh script.<br>
It could be that it takes much longer, especially when the chain is bigger and you start from scratch. If you start Lisk Service before Lisk Core is in sync, it can lead to database errors.<br>
If you started from scratch, only run Lisk Core (pm2 start core-start.json) and let it get in sync with the network and stop Lisk Core before you use this starteverything.sh script.<br>

<br><em>Ok, now we go on. You need to know where your pm2 and npm on your machine is:</em><br>
<code><span class="nohigh">~$ </span> which pm2</code><br>
<code><span class="nohigh">~$ </span> which npm</code><br>
<br><em>If the results are for example this...</em><br>
<div id="box"><pre>/home/lisk/.nvm/versions/node/v12.22.5/bin/npm
/home/lisk/.nvm/versions/node/v12.22.5/bin/pm2</div></pre>
...then you need to add the paths into the starteverything.sh (without the pm2 and npm at the end... or add both full paths, no idea)
<br><br>

<code><p><span class="nohigh">~$ </span> cd && nano starteverything.sh</code><br><br>

<em>Add your paths to pm2 and npm below after "export" and add everything else and save the file:</em><br>
<div id="box"><pre>
#!/bin/bash
export PATH=$PATH:/home/lisk/.nvm/versions/node/v12.22.5/bin/
pm2 start core-start.json
sleep 120
cd lisk-service
npm start
</pre></div>

<br><em>Make it executable and start it:</em><br>

<code><p><span class="nohigh">~$ </span> chmod +x starteverything.sh<br>
<span class="nohigh">~$ </span> ./starteverything.sh</code>

<br><br><em>Now open the pm2-monitor to see the logs for each process:</em>
<code><p><span class="nohigh">~$ </span>pm2 monit</code>
<br><br>
 Wait until it is in sync and then use Lisk Desktop to connect to your Service node -> https://lisk-mainnet-service.YOURDOMAIN.TLD</em>

<br><br><br>
<h3 id="step13">13. Add an @reboot-Cronjob</h3>
<br>
<em>This cronjob starts your starteverything.sh scripts after a reboot:</em><br><br>

<br><em>Check where bash is:</em><br>
<code><span class="nohigh">~$ </span> which bash</code><br>

<br><em>In the following cronjob line i use /usr/bin/bash as this was my result:</em><br><br>

<code><span class="nohigh">~$ </span> crontab -e</code><br><br></code>

Add this, save and close:
<div id="box"><pre>
@reboot sleep 20 && /usr/bin/bash /home/lisk/starteverything.sh > $HOME/reboot-logs/date +%Y-%m-%d_%H:%M:%S-crontablogs.log 2>&1
</pre></div>
<br>

<br><em>Now reboot and open pm2 monit:</em><br>
<code><span class="nohigh">~$ </span> pm2 monit</code><br>

<br><em>Lisk Core should show up and 120 seconds later, should all three service processes show up (service-core, service-gateway, service-market).<br>
<br>To check if everything works, visit these two domains:<br></em>
<div id="box"><pre>
- https://lisk-mainnet-service.YOURDOMAIN.TLD/api/v2/network/status<br>
- https://lisk-mainnet-service.YOURDOMAIN.TLD/api/status<br></pre></div><br>
If you get some good looking results, nice. You now can connect with Lisk Desktop to your domain: <a href="https://lisk-mainnet-service.YOURDOMAIN.TLD">https://lisk-mainnet-service.YOURDOMAIN.TLD</a><br>
If you see errors, bad. Try again and good luck. 
<br><br><br><br>

<div id="update">
<h3 id="step14">14. Update Lisk Service</h3>
<code>
<span class="nohigh">~$ </span>pm2 stop all<br>
<span class="nohigh">~$ </span>pm2 delete all<br>
<span class="nohigh">~$ </span>cp lisk-service/ecosystem.core3.config.js ecosystem.core3.config.js<br>
<span class="nohigh">~$ </span>rm -rf lisk-service<br>
<span class="nohigh">~$ </span>npm remove -g lisk-service<br><br>

Now (if you have) disable/comment (add # before the line) reboot script in crontab:<br>
<span class="nohigh">~$ </span>crontab -e<br>
<span class="nohigh">~$ </span>sudo reboot<br>
<span class="nohigh">~$ </span>git clone https://github.com/LiskHQ/lisk-service.git<br>
<span class="nohigh">~$ </span>cp ecosystem.core3.config.js lisk-service/ecosystem.core3.config.js<br>
<span class="nohigh">~$ </span>rm -rf ecosystem.core3.config.js<br>
<span class="nohigh">~$ </span>cd lisk-service<br>
<span class="nohigh">~$ </span>git fetch && git pull<br>
<span class="nohigh">~$ </span>git checkout latest<br>
<span class="nohigh">~$ </span>make build-local<br>
<span class="nohigh">~$ </span>cd && cd lisk-service/services/market<br>
<span class="nohigh">~$ </span>npm i<br>
<span class="nohigh">~$ </span>cd<br>
<span class="nohigh">~$ </span>./starteverything.sh<br><br>

Now (if you have) enable/uncomment reboot script again in crontab:<br>
<span class="nohigh">~$ </span>crontab -e<br>

</code>
</div><br><br><br>


<em><b>Other pm2 commands:</b></em><br>
pm2 restart all<br>
pm2 stop all<br>
pm2 start all<br>
pm2 status<br>
pm2 delete all<br>
pm2 save<br>

<br><br><br>
<h3 id="step15">15. Credits</h3>
<br>
<em>Thanks to lemii, przemer and Corbifex for helping.
Happy forging on Lisk v3 mainnet!
<br><br><b>punkrock</b></em>
<br><br>